- デフォルトでマルチAZが有効
- S3 バケット
    - 3~63で命名。グローバルでユニークな名前にする必要あり。

## バケットの種類

### S3 Glacier

- 迅速取り出し
    - 1~5分、250MB以内
- 標準取り出し
    - 3~5時間(Flexible Retrieval)、9~12時間(Deep Archive)
- 大容量取り出し
    - 5~12時間。最も安価。

### S3 intelligent-Tiering

- 高頻度と低頻度の2つのアクセス階層を持つ。データのモニタリングを行い、連続で30日アクセスされていないデータは低頻度の階層へ移動する。アクセスがあった時は高頻度層に戻る。

### S3 One-Zone-Infrequent-Access

- 長期保管。低アクセス。低コスト。

### S3 Standard

- アクセス頻度の高いデータ向けに、高耐久性、高可用性、高パフォーマンス。

### S3 Standard Infrequent-Access

- 長期保管、低アクセスをS3標準と同じ耐久性、パフォーマンスで提供。

### S3 Select

- SQLを使用してアプリケーションがS3オブジェクトからデータのサブセットのみを取得できる。

## S3 オブジェクトロック

### リーガルホールド

- 保持期間が無限。ルートユーザーを含むすべてのユーザーに対して、リーガルホールドが解除されるまで、読み取り専用になる。権限をもつユーザーのみ、解除が行える。

### リテンションモード

- 保持期間が期限付き

#### ガバナンスモード

- 権限を持たないユーザーに対して保持期間内は読み取り専用にする。権限を持つユーザーのみ、書き込みとガバナンスモードの解除ができる。

#### コンプライアンスモード

- ルートユーザーを含む全てのユーザーに対して保持期間は読み取り専用にする。リテンション期間が終了するまで解除も行えず、オブジェクトは完全に保護される。

## CORS（クロスオリジンリソース共有）

- 異なるオリジン間のリクエストを許可できる。
- 前提
    - 同一オリジンポリシーというセキュリティ制限がある。ウェブサイトと異なるドメイン（オリジン）にあるリソースを取得するリクエストは、デフォルトでブロックされる。以下参照。
        - 自社のウェブサイト（https://example.com）にあるJavaScriptがS3のオブジェクト（https://my-bucket.s3.amazonaws. com/sctipt.js）を取得しようとすると、異なるオリジン間の通信となるため、ブラウザがブロックする。
- 仕組み
    - ブラウザがAmazon S3にリクエストを送る。
    - S3はCORS設定を確認し、許可されていればレスポンスに適切なヘッダーを付与して返す。
    - ブラウザはレスポンスヘッダーを確認し、リクエストを受け入れるか判断する。

## S3イベント通知

### できること

- オブジェクトに対するイベントをトリガーにして、指定のターゲットに通知できる
    - `s3:ObjectCreated:*` , `s3:ObjectRemoved:*` , `s3:ObjectRestore:*` 等に対して、SNS・SQS・Lambda・EventBridge等に通知
- 特定のフォルダ(`/etc/log/` )や特定の拡張子(`.pdf`)だけを対象にできる

### できないこと

- フォルダの作成・削除の検知
    - UI上はファイル構造になっているが、実際はオブジェクト構造でただのキーにすぎないから
- イベントの完全保証
    - 完全に1回だけの通知は不可能。重複する可能性がある。
- オブジェクトの更新
    - 更新も `s3:ObjectCreated:*` として扱われるため、新規作成と変わらない。
- バケットの状態や設定変更の通知（CloudTrailを使って実現するしかない）
    - バケットポリシー変更
    - バケットACL変更
    - バージョニング設定変更
    - ライフサイクルポリシー変更

## アップロードのパフォーマンス向上

### Transfer Accelarator

CloudFrontのエッジロケーションを利用して、世界中からのアップロードを高速化する

### マルチパートアップロード

並列にアップロードすることでスループットを向上させる。途中で失敗しても再開できる。

### 使い分け

| 条件 | 向いている手法 |
| --- | --- |
| 世界中の地域から S3 に **小〜中サイズのファイル**をアップロード | **Transfer Acceleration** |
| 1GB などの **大きなファイル**をアップロードしたい | **マルチパートアップロード** |
| 世界中の地域から大きなファイルをアップロード | **Transfer Acceleration + マルチパートアップロードの併用** |
| 同一リージョン内でのアップロードが主目的 | マルチパートだけで OK（Transfer Acceleration の恩恵は少ない） |

## クロスアカウントアクセス

### 前提

アカウントA…アクセス元、VPCやVPCエンドポイントを持つ側

アカウントB…アクセス先、S3バケットを所有する側

### 1. IAMポリシーの設定（アカウントAで使うIAMロールまたはユーザー）

アカウントA側でARNを指定する。

IAMユーザーやIAMロールを用いてARNを設定。書き込みが必要ならs3:PutObjectも追加。

### 2. VPCエンドポイントポリシー（アカウントAで定義）

アカウントA側でVPCエンドポイントがアクセスできるS3リソースを制限する。

Principalを絞ってセキュリティを高めるのが理想（最小構成 `*` でも動作する）

### 3. S3バケットポリシー（アカウントBで定義）

`aws:SourceVpce` を使って「このVPCエンドポイント経由からのリクエストだけ許可」する。

これにより、パブリック経由のアクセスを完全に遮断する。

# AWS CLI

## —acl オプション一覧

| 値 | 意味・概要 |
| --- | --- |
| `private` | **完全に非公開（デフォルト）**。バケット/オブジェクト所有者以外にはアクセスなし。 |
| `public-read` | 読み取り（GET）を**全員に許可**。書き込みは所有者のみ。 |
| `public-read-write` | 読み書きともに**全員に許可**（※バケットに使うと危険）。 |
| `authenticated-read` | **AWS アカウントを持つ全ユーザーに読み取り許可**。書き込みはなし。 |
| `aws-exec-read` | AWS が内部で使う（例：Amazon EC2 がバケットから起動スクリプトを読むなど）用途向け。EC2実行用。主に Amazon マネージドサービス利用時。 |
| `bucket-owner-read` | **バケット所有者に読み取りを許可**（オブジェクトアップロード者が別の場合に有効）。 |
| `bucket-owner-full-control` | バケット所有者に**完全な権限（読み書き・メタデータ更新など）を許可**。組織横断アップロードで多用される。 |
| `log-delivery-write` | S3アクセスログ配信を目的に使うACL。S3ログ配信用に必要な書き込み権限を与える。 |