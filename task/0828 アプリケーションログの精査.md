# 調査
railsのログレベルは5段階。
したから2番目の `info` に設定しているため、debug logは出力されていない。

# 出力ログ
- Railsログ
	- log_levelは `info`であり、これは変更不可。
- Sentry
	- 送信したときのログ
- datadog
	- 送信したときのログ

[アプリケーションログの精査](https://docs.google.com/spreadsheets/d/1EV0nwACvh0ZaieMZTpmvd6-pFu6MaoP8kyoctfvCMmc/edit?gid=1008919601#gid=1008919601)


# 標準出力への変更
systemdを用いてpumaやsidekiqのサービスを動かしている。
現在出力方法をファイルハンドルしているが、コンテナ化なども考慮し標準出力へ移行する必要がある。
標準出力に変更した場合、ログは各サービスのjournaldで確認できるようになる。journalによるファイル出力を永続化させるには、以下の設定が必要
- /etc/system/jourcal.confでstorageをpersistnetに変更する
	- これにより、出力先をtmpディレクトリから /var/log/journacl/に変更でき、ログの永続化が可能となる。
	- 問題点として、journaclディレクトリへ出力されたログは、.journalというファイル形式でバイナリデータとして保存されているため、そのままではCW Agent経由でのストリームができない。
- rsyslogを用いてバイナリ形式を人間が読める形式に変更し、CWへストリームを行う。

#### 補足
journalファイルはサービスごとに生成されるなどのものではなく、バラバラに保存されている。journaldというサービスがこれらのバラバラを適切にフィルタリングしてくれることで、journalctlコマンドでサービスごとのログを確認することができる。


# Sidekiqのログ出力化
[sidekiq.yaml](https://taroooth.hatenablog.com/entry/2023/07/08/100520#:~:text=:pidfile:%20./tmp/pids/sidekiq.pid%20:%20Sidekiq%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9ID%E3%82%92%E4%BF%9D%E5%AD%98%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%91%E3%82%B9%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%E3%81%93%E3%82%8C%E3%81%AF%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%8C%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E9%96%93%E3%80%81%E3%81%9D%E3%81%AE%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9ID%E3%82%92%E4%BF%9D%E6%8C%81%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%20:logfile:%20./log/sidekiq.log%20:%20Sidekiq%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%8C%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E3%83%91%E3%82%B9%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%BE%E3%81%99%E3%80%82%20:concurrency:%2010%20:%20%E5%90%8C%E6%99%82%E3%81%AB%E5%AE%9F%E8%A1%8C%E5%8F%AF%E8%83%BD%E3%81%AA%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E6%9C%80%E5%A4%A7%E6%95%B0%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%BE%E3%81%99)

## production.logのログ量が多い理由
### 前提
すべてのログにdatadogのメタデータが付随するため、出力される行が増えるのに比例してログ量も増える

### 出力される行が増えている理由
- 全てのAPIについて以下が出力される
	- `app/controllers/concerns/current.rb`
		- set_current_user
			- これは現在のユーザーの権限と、projectを表示するというもの。projectについては汎用版での名残であるため、ENEOS版についてはほぼ意味のないログ出力になっている。
	- ``